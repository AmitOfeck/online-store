<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Eats</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="style.css" rel="stylesheet">
</head>
<body>
  <header>
    <!--Top Nav Bar-->
    <nav class="navbar navbar-expand-lg navbar-custom">
      <div class="container-fluid">
        <div class="navbar-brand">
            <button class="btn btn-filter" id="logout-button"><a href="homepage.html" class="login_btn">Log Out</a></button>
        </div>
        <div class="navbar-nav">
          <div class="nav-item">
            <div class="input-group">
              <input type="text" class="form-control" placeholder="Search in Super Eats">
            </div>
          </div>
        </div>
        <div class="nav-right">
          <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-list"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <a class="Cat">Menu</a>
              <li><a class="dropdown-item" href="#"><img src="Pictures/milk-dairy-icon.jpg" class="icon"> Dairy and Eggs</a></li>
              <li><a class="dropdown-item" href="#"><img src="Pictures/fruit-icon.jpg" class="icon"> Fruit and Vegetables</a></li>
              <li><a class="dropdown-item" href="#"><img src="Pictures/fish-meat-icon.jpg" class="icon"> Meat and Fish</a></li>
              <li><a class="dropdown-item" href="#"><img src="Pictures/sweetandsalty-icon.jpg" class="icon"> Sweet & Salty</a></li>
              <li><a class="dropdown-item" href="#"><img src="Pictures/drink-icon.jpg" class="icon"> Beverages</a></li>
              <li><a class="dropdown-item" href="#"><img src="Pictures/frozen-icon.jpg" class="icon"> Frozen Produce</a></li>
            </ul>
          </div>
          <a class="navbar-brand"  href="homepage.html">
            <img src="Pictures/logo.jpg" alt="Logo">
          </a>
        </div>
      </div>
    </nav>
  </header>

  <div class="container-fluid main-content">
    <div class="row">
      <div class="col-md-9">
        <div id="product-list">
          <!-- Products will be injected here by JavaScript -->
        </div>
      </div>

      <!--Cart Section-->
      <div class="col-md-3 cart-section">
        <h4>Shopping Cart</h4>
        <div class="cart-content">
          <!-- Cart items will go here -->
          <div id="cart-items"></div>
          <p class="reg-text">Total Sum: <span id="total-sum">0</span></p>
          <div class="d-grid gap-2">
            <button class="btn btn-primary btn-block purchase-button" onclick="payNow()">Pay Now <i class="bi bi-cart"></i></button>
            <button class="btn btn-danger btn-block clear-button" id="Clear-Cart" onclick="clearCart()">Clear Cart <i class="bi bi-trash"></i></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    let products = [];
    let cart = [];
    const productList = document.getElementById('product-list');
    const cartItems = document.getElementById('cart-items');
    const totalSum = document.getElementById('total-sum');

    async function fetchProducts() {
      try {
        const token = localStorage.getItem('token'); 
        const response = await fetch('http://localhost:8080/products/', {
          method: 'GET',
          headers: {
            'Authorization': `${token}` 
          }
        });

        if (!response.ok) {
          console.log('Response Status:', response.status);
          console.log('Response Status Text:', response.statusText);
          throw new Error('Failed to fetch products');
        }

        products = await response.json();
        renderProducts(products);
      } catch (error) {
        console.error('Error fetching products:', error);
      }
    }

    async function fetchCart() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:8080/orders/get-my-cart', {
          method: 'GET',
          headers: {
            'Authorization': `${token}`
          }
        });

        if (!response.ok) {
          console.log('Response Status:', response.status);
          console.log('Response Status Text:', response.statusText);
          throw new Error('Failed to fetch cart');
        }

        const order = await response.json();
        localStorage.setItem('orderId' , order._id)
        cart = order.items;
        renderCart();
      } catch (error) {
        console.error('Error fetching cart:', error);
      }
    }

    function renderProducts(products) {
      productList.innerHTML = '';
      products.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';

        productCard.innerHTML = `
          <img src="${product.image}" alt="${product.name}">
          <h5>${product.name}</h5>
          <p>${product.weight} ${product.weightUnit}</p>
          <p>$${product.price}</p>
          <button class="btn btn-add-to-cart" onclick="addToCart('${product._id}')">Add to Cart</button>
        `;

        productList.appendChild(productCard);
      });
    }

    function renderCart() {
  cartItems.innerHTML = '';
  let sum = 0;


  cart.forEach(item => {
    const product = products.find(p => p._id === item.id)

    if (!product) {
      console.warn(`Product with ID ${item.productId} not found`);
      return; 
    }

    const cartItem = document.createElement('div');
    cartItem.className = 'cart-item';

    cartItem.innerHTML = `
      <div class="input-group small-input-group">
        <div class="input-group-prepend">
          <button class="btn btn-outline-secondary" type="button" onclick="decreaseQuantity('${item.id}')">-</button>
        </div>
        <input type="text" class="form-control text-center" value="${item.quantity}" readonly>
        <div class="input-group-append">
          <button class="btn btn-outline-secondary" type="button" onclick="increaseQuantity('${item.id}')">+</button>
        </div>
      </div>
      <div class="ml-3 cart-prod-info">
        <span class="cart-prod-text">${product.name}</span>
        <span class="cart-prod-text">$${product.price}</span>
      </div>
      <div class="ml-auto">
        <img src="${product.image}" alt="${product.name}">
      </div>
    `;

    cartItems.appendChild(cartItem);
    sum += product.price * item.quantity;
  });

  totalSum.innerText = sum.toFixed(2);
}

async function addToCart(productId) {
  try {
    
    // Retrieve the current order ID (you should store it in a variable or localStorage)
    const orderId = localStorage.getItem('orderId'); // Adjust as necessary
    
    const response = await fetch(`http://localhost:8080/orders/${orderId}/add-to-cart/${productId}`, {
      method: 'POST',
      headers: {
        'Authorization': `${localStorage.getItem('token')}`, // Include token for authentication
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error(`Error adding to cart: ${response.statusText}`);
    }

    const cartUpdate = await response.json();

    // Assuming cartUpdate contains the updated cart info
    cart = cartUpdate.items;
    renderCart();
  } catch (error) {
    console.error('Error adding to cart:', error);
  }
}


async function increaseQuantity(productId) {
  try {
    const orderId = localStorage.getItem('orderId'); // Retrieve the order ID
    const response = await fetch(`http://localhost:8080/orders/${orderId}/add-to-cart/${productId}`, {
      method: 'POST',
      headers: {
        'Authorization': `${localStorage.getItem('token')}`, // Include token for authentication
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error(`Error increasing quantity: ${response.statusText}`);
    }

    const cartUpdate = await response.json();
    cart = cartUpdate.items; // Update cart with the latest items
    renderCart(); // Re-render the cart
  } catch (error) {
    console.error('Error increasing quantity:', error);
  }
}



async function decreaseQuantity(productId) {
  try {
    const orderId = localStorage.getItem('orderId'); // Retrieve the order ID
    const response = await fetch(`http://localhost:8080/orders/${orderId}/remove-from-cart/${productId}`, {
      method: 'POST',
      headers: {
        'Authorization': `${localStorage.getItem('token')}`, // Include token for authentication
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error(`Error decreasing quantity: ${response.statusText}`);
    }

    const cartUpdate = await response.json();
    cart = cartUpdate.items; // Update cart with the latest items
    renderCart(); // Re-render the cart
  } catch (error) {
    console.error('Error decreasing quantity:', error);
  }
}

async function payNow() {
  try {
    const orderId = localStorage.getItem('orderId'); // Retrieve the current order ID
    const token = localStorage.getItem('token');


    const res = await fetch('http://localhost:8080/orders/get-my-cart', {
          method: 'GET',
          headers: {
            'Authorization': `${token}`
          }
        });

        if (!res.ok) {
          console.log('Response Status:', res.status);
          console.log('Response Status Text:', res.statusText);
          throw new Error('Failed to fetch cart');
        }

    const order = await res.json();
    order.ordered = true;

    const response = await fetch(`http://localhost:8080/orders/${orderId}`, {
      method: 'PATCH',
      headers: {
        'Authorization': `${token}`, // Include token for authentication
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(order) // Set the `ordered` status to true
    });

    if (!response.ok) {
      throw new Error(`Error completing the order: ${response.statusText}`);
    }

    // Show success alert
    alert('The order will be sent to your address');

    // Fetch the updated cart
    await fetchCart();
  } catch (error) {
    console.error('Error processing payment:', error);
  }
}


    async function updateCart() {
      try {
        const token = localStorage.getItem('token');
        await fetch('http://localhost:8080/orders/get-my-cart', {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `${token}`
          },
          body: JSON.stringify({ items: cart })
        });
      } catch (error) {
        console.error('Error updating cart:', error);
      }
    }

    fetchProducts();
    fetchCart();
  </script>
</body>
</html>
